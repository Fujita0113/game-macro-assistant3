# GameMacroAssistant テスト手順書

## 📋 テスト環境

**必要な環境:**
- Windows 10/11 (64-bit)
- .NET 8.0 Runtime
- 管理者権限（低レベルフック使用のため）
- ディスプレイスケール: 100% 推奨

## 🚀 アプリケーション起動テスト

### 1. ビルドと起動

```bash
# プロジェクトディレクトリで実行
cd C:\Users\yufuj\Desktop\gameAutoProject3

# ビルド
dotnet build GameMacroAssistant.sln --configuration Release

# アプリケーション起動
dotnet run --project src/GameMacroAssistant.Wpf/GameMacroAssistant.Wpf.csproj
```

**期待される結果:**
- エラーなくビルド完了
- GameMacroAssistantのメインウィンドウが表示
- ツールバーに記録・再生・編集ボタンが表示

### 2. 初期状態確認

**確認項目:**
- [ ] メインウィンドウが正常に表示される
- [ ] ツールバーボタンが適切に配置されている
- [ ] ステータスバーに "Ready" と表示される
- [ ] マクロリストが空の状態で表示される

---

## 🔴 マクロ記録機能テスト

### テスト1: 基本的な記録機能

**手順:**
1. **管理者権限でアプリケーションを起動**
   ```bash
   # PowerShellを管理者権限で開いて実行
   dotnet run --project src/GameMacroAssistant.Wpf/GameMacroAssistant.Wpf.csproj
   ```

2. **記録開始**
   - 🔴「Record」ボタンをクリック
   - ステータスメッセージが "Recording... Press ESC to stop" に変更されることを確認

3. **操作実行**
   - メモ帳を開く
   - 簡単な文字列を入力（例："Hello World"）
   - マウスクリックを数回実行

4. **記録停止**
   - **ESCキー**を押す
   - 記録が停止し、"Recording completed. X steps recorded" メッセージが表示される

**期待される結果:**
- [ ] Windows APIフックが正常に動作
- [ ] マウス・キーボードイベントが記録される
- [ ] ESCキーで正常に停止
- [ ] 記録されたステップ数が表示される

### テスト2: 記録データの確認

**手順:**
1. 記録完了後、ログファイルを確認
   ```
   場所: %APPDATA%\GameMacroAssistant\Logs\<YYYY-MM-DD>.log
   ```

2. ログ内容を確認
   - マウスイベントの座標が記録されているか
   - キーボードイベントの仮想キーコードが記録されているか
   - タイムスタンプが正確に記録されているか

**期待される結果:**
- [ ] JSON形式でログが記録されている
- [ ] マウス座標が絶対座標で記録されている（R-002）
- [ ] キーボードの仮想キーコードが記録されている（R-003）

---

## 💾 ファイル保存・読み込みテスト

### テスト3: マクロファイル保存

**手順:**
1. 記録したマクロを選択
2. 「Save」ボタンをクリック
3. ファイル保存先を確認
   ```
   デフォルト: %USERPROFILE%\Documents\GameMacroAssistant\Macros\
   ```

**期待される結果:**
- [ ] `.gma.json` 形式でファイルが保存される
- [ ] JSONスキーマ v1.0 に準拠している
- [ ] 必須フィールド（id, name, schemaVersion, steps）が含まれている

### テスト4: マクロファイル読み込み

**手順:**
1. 「Load」ボタンをクリック
2. 既存の `.gma.json` ファイルを選択
3. マクロリストに追加されることを確認

**期待される結果:**
- [ ] ファイルが正常に読み込まれる
- [ ] マクロリストに表示される
- [ ] マクロの詳細情報が正確に表示される

### テスト5: 暗号化機能テスト（R-018）

**手順:**
1. 新しいマクロを作成
2. 保存時に8桁以上のパスフレーズを設定
3. ファイルを保存後、アプリケーションを再起動
4. 暗号化されたファイルを読み込み

**パスフレーズテスト:**
- 有効: `password123` (8文字以上)
- 無効: `pass` (8文字未満)

**期待される結果:**
- [ ] 8文字未満のパスフレーズは拒否される
- [ ] 暗号化されたファイルが正常に保存される
- [ ] 正しいパスフレーズで復号化できる
- [ ] 間違ったパスフレーズは3回まで試行可能

---

## 🎮 マクロ実行テスト

### テスト6: 基本実行機能

**手順:**
1. 記録・保存されたマクロを選択
2. 「Play」ボタンをクリック
3. マクロが自動実行されることを確認

**期待される結果:**
- [ ] 記録された操作が正確に再現される
- [ ] マウスクリックが正しい座標で実行される
- [ ] キーボード入力が正確に再現される

### テスト7: 画像マッチング機能テスト（R-013）

**手順:**
1. スクリーンショットを含むマクロを作成
2. 画像マッチング設定を調整:
   - SSIM閾値: 0.95 → 0.85
   - ピクセル差分: 3% → 5%
3. 条件付きステップを実行

**期待される結果:**
- [ ] デフォルト設定（SSIM 0.95, ピクセル差3%）で動作
- [ ] 設定画面で閾値を変更可能
- [ ] 変更した閾値でマッチングが動作

---

## ⚙️ 設定・機能テスト

### テスト8: ビジュアルエディタテスト（R-009）

**手順:**
1. 記録したマクロの「Edit」ボタンをクリック
2. エディタウィンドウが開くことを確認
3. Undo/Redo機能をテスト:
   - ステップを削除
   - Ctrl+Z でUndo
   - Ctrl+Y でRedo

**複合操作テスト:**
- 2秒以内に複数の操作を実行
- Undo時に1つの操作として扱われるか確認

**期待される結果:**
- [ ] ビジュアルエディタが開く
- [ ] ステップの順序変更が可能
- [ ] Undo/Redo機能が正常動作
- [ ] 2秒以内の操作が1つにグループ化される

### テスト9: パフォーマンステスト（R-020）

**手順:**
1. 長時間のマクロ実行中にタスクマネージャーで監視
2. リソース使用量を確認:
   - CPU使用率
   - メモリ使用量

**期待される結果:**
- [ ] CPU使用率が15%以下で維持される
- [ ] メモリ使用量が300MB以下で維持される
- [ ] 閾値超過時に「High Load」トーストが表示される
- [ ] 進捗バーが赤色に変化する

---

## 🐛 エラーハンドリングテスト

### テスト10: スクリーンキャプチャ失敗テスト（R-006）

**手順:**
1. 全画面アプリケーション（ゲームなど）を起動
2. マクロ記録を開始
3. キャプチャ失敗をシミュレート

**期待される結果:**
- [ ] Desktop Duplication API失敗時にGDI BitBltにフォールバック
- [ ] "CaptureLimited" ウォーターマークが表示される
- [ ] 最大15 FPSに制限される
- [ ] ログに `Err-CAP` エラーコードが記録される

### テスト11: タイミング精度テスト（R-014）

**手順:**
1. 高精度タイミングが必要なマクロを作成
2. 実行時のタイミング精度を測定
3. ログでタイミングエラーを確認

**期待される結果:**
- [ ] 平均タイミング誤差が5ms以下
- [ ] 最大タイミング誤差が15ms以下
- [ ] 基準超過時にログに `Err-TIM` が記録される

---

## 📊 自動テスト実行

### 単体テスト実行

```bash
# すべてのテストを実行
dotnet test GameMacroAssistant.sln --configuration Release

# 詳細な出力で実行
dotnet test GameMacroAssistant.sln --configuration Release --verbosity detailed

# 特定のテストクラスのみ実行
dotnet test --filter "FullyQualifiedName~MacroTests"
```

**期待される結果:**
- [ ] すべてのテストが成功する
- [ ] テストカバレッジが十分である

---

## 🚨 トラブルシューティング

### よくある問題と解決方法

**1. 管理者権限エラー**
```
Error: Failed to install mouse hook. Error: 5
```
**解決方法:** アプリケーションを管理者権限で起動

**2. DPIスケーリング問題**
```
マウス座標がずれる
```
**解決方法:** ディスプレイ設定を100%スケールに変更

**3. ファイル読み込みエラー**
```
Failed to load macro: Invalid passphrase
```
**解決方法:** 正しいパスフレーズを入力（3回まで試行可能）

**4. 画像マッチング失敗**
```
Image match condition failed
```
**解決方法:** 
- SSIM閾値を下げる（0.95 → 0.85）
- ピクセル差分閾値を上げる（3% → 5%）

---

## ✅ テスト完了チェックリスト

### 基本機能
- [ ] アプリケーション起動・終了
- [ ] マクロ記録（マウス・キーボード）
- [ ] マクロ保存・読み込み
- [ ] マクロ実行・停止

### 高度な機能
- [ ] 暗号化機能（パスフレーズ保護）
- [ ] 画像マッチング
- [ ] ビジュアルエディタ（Undo/Redo）
- [ ] パフォーマンス監視

### エラーハンドリング
- [ ] スクリーンキャプチャ失敗時の処理
- [ ] タイミング精度エラーの検出
- [ ] ファイル操作エラーの処理
- [ ] 権限不足エラーの処理

### ログ・監視
- [ ] JSON形式ログの出力
- [ ] エラーコードの記録
- [ ] パフォーマンス指標の監視

---

## 📝 テスト報告書テンプレート

```markdown
# テスト実行報告書

**実行日:** YYYY-MM-DD
**テスト環境:** Windows 11, .NET 8.0
**実行者:** [名前]

## テスト結果サマリー
- 実行テスト数: X件
- 成功: X件
- 失敗: X件
- スキップ: X件

## 詳細結果
[各テストの結果を記載]

## 発見された問題
[問題があれば記載]

## 推奨事項
[改善提案があれば記載]
```

このテスト手順書に従って、GameMacroAssistantの全機能を体系的に検証できます。